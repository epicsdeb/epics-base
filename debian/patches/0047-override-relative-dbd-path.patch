From 242afb6deccaf607e5d73167087a1c6ae8dc4c9c Mon Sep 17 00:00:00 2001
From: Evan Daykin <daykin@frib.msu.edu>
Date: Thu, 7 Apr 2022 14:38:40 -0400
Subject: [PATCH 1/3] fall back to EPICS_BASE/dbd/softIoc.dbd

---
 modules/database/src/std/softIoc/softMain.cpp | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

Index: epics-base/modules/database/src/std/softIoc/softMain.cpp
===================================================================
--- epics-base.orig/modules/database/src/std/softIoc/softMain.cpp
+++ epics-base/modules/database/src/std/softIoc/softMain.cpp
@@ -29,6 +29,7 @@
 #include "iocsh.h"
 #include "osiFileName.h"
 #include "epicsInstallDir.h"
+#include "dbStaticPvt.h"
 
 extern "C" int softIoc_registerRecordDeviceDriver(struct dbBase *pdbbase);
 
@@ -38,6 +39,8 @@ extern "C" int softIoc_registerRecordDev
 #  error -DEPICS_BASE required
 #endif
 
+
+
 #define DBD_BASE "dbd" OSI_PATH_SEPARATOR "softIoc.dbd"
 #define EXIT_BASE "db" OSI_PATH_SEPARATOR "softIocExit.db"
 #define DBD_FILE_REL ".." OSI_PATH_SEPARATOR ".." OSI_PATH_SEPARATOR DBD_BASE
@@ -53,14 +56,15 @@ static void exitSubroutine(subRecord *pr
     epicsExitLater((precord->a == 0.0) ? EXIT_SUCCESS : EXIT_FAILURE);
 }
 
-void usage(const char *arg0, const std::string& base_dbd) {
+void usage(const char *arg0, const std::string& base_dbd, const std::string& prefix) {
     std::cout<<"Usage: "<<arg0<<
                " [-D softIoc.dbd] [-h] [-S] [-s] [-v] [-a ascf]\n"
                "[-m macro=value,macro2=value2] [-d file.db]\n"
                "[-x prefix] [st.cmd]\n"
                "\n"
-               "    -D <dbd>  If used, must come first. Specify the path to the softIoc.dbdfile."
+               "    -D <dbd>  If used, must come first. Specify the path to the softIoc.dbdfile.\n"
                "        The compile-time install location is saved in the binary as a default.\n"
+               "        If the compile-time default is not found, EPICS_BASE/dbd will also be tried.\n"
                "\n"
                "    -h  Print this mesage and exit.\n"
                "\n"
@@ -92,7 +96,10 @@ void usage(const char *arg0, const std::
                "interactive IOC shell.\n"
                "\n"
                "Compiled-in path to softIoc.dbd is:\n"
-               "\t"<<base_dbd.c_str()<<"\n";
+               "\t"<<prefix+DBD_FILE_REL<<std::endl;
+               if(base_dbd == prefix+DBD_FILE_REL){
+                   std::cout<<"If it can't be located here, EPICS_BASE/dbd/softIoc.dbd will also be tried."<<std::endl;
+               }
 }
 
 void errIf(int ret, const std::string& msg)
@@ -103,17 +110,33 @@ void errIf(int ret, const std::string& m
 
 bool lazy_dbd_loaded;
 
-void lazy_dbd(const std::string& dbd_file) {
+void lazy_dbd(const std::string& dbd_file, const std::string& prefix) {
     if(lazy_dbd_loaded) return;
     lazy_dbd_loaded = true;
-
-    if (verbose)
-        std::cout<<"dbLoadDatabase(\""<<dbd_file<<"\")\n";
-    errIf(dbLoadDatabase(dbd_file.c_str(), NULL, NULL),
-          std::string("Failed to load DBD file: ")+dbd_file);
-
+    std::string loaded_file;
+    FILE *fp = NULL;
+    std::string dbd_relative_to_epics_base(DBD_FILE);
+    loaded_file = dbd_file;
+    dbOpenFile(&pdbbase, dbd_file.c_str(), &fp);
+    if((!fp) && dbd_file==prefix+DBD_FILE_REL){
+        loaded_file=dbd_relative_to_epics_base;
+        std::cerr<<"Failed to open DBD file: "<<dbd_file<<std::endl;
+        std::cerr<<"Trying to open it relative to EPICS_BASE instead..."<<std::endl;
+        dbOpenFile(&pdbbase,dbd_relative_to_epics_base.c_str(),&fp);
+        if(fp)
+            std::cout<<"Found softIoc.dbd in"<<dbd_relative_to_epics_base<<"."<<std::endl;
+    }
+    if(!fp){
+        std::cerr<<"Failed to open DBD file from "<<dbd_file;
+        if(dbd_file==prefix+DBD_FILE_REL)
+            std::cerr<<" and "<<dbd_relative_to_epics_base;
+        std::cerr<<"."<<std::endl;
+    }
+    else if(dbReadDatabaseFP(&pdbbase, fp, NULL, NULL)){
+        std::cerr<<"Failed to read "<<loaded_file<<", but it was found and loaded."<<std::endl;
+    }
     if (verbose)
-        std::cout<<"softIoc_registerRecordDeviceDriver(pdbbase)\n";
+        std::cout<<"softIoc_registerRecordDeviceDriver(pdbbase)"<<std::endl;
     errIf(softIoc_registerRecordDeviceDriver(pdbbase),
           "Failed to initialize database");
     registryFunctionAdd("exit", (REGISTRYFUNCTION) exitSubroutine);
@@ -133,38 +156,36 @@ int main(int argc, char *argv[])
         bool ranScript = false;
 
         // attempt to compute relative paths
-        {
-            std::string prefix;
-            char *cprefix = epicsGetExecDir();
-            if(cprefix) {
-                try {
-                    prefix = cprefix;
-                    free(cprefix);
-                } catch(...) {
-                    free(cprefix);
-                    throw;
-                }
+        std::string prefix;
+        char *cprefix = epicsGetExecDir();
+        if(cprefix) {
+            try {
+                prefix = cprefix;
+                free(cprefix);
+            } catch(...) {
+                free(cprefix);
+                throw;
             }
-
-            dbd_file = prefix + DBD_FILE_REL;
-            exit_file = prefix + EXIT_FILE_REL;
         }
 
+        dbd_file = prefix + DBD_FILE_REL;
+        exit_file = prefix + EXIT_FILE_REL;
+
         int opt;
 
         while ((opt = getopt(argc, argv, "ha:D:d:m:Ssx:v")) != -1) {
             switch (opt) {
             case 'h':               /* Print usage */
-                usage(argv[0], dbd_file);
+                usage(argv[0], dbd_file, prefix);
                 epicsExit(0);
                 return 0;
             default:
-                usage(argv[0], dbd_file);
+                usage(argv[0], dbd_file, prefix);
                 std::cerr<<"Unknown argument: -"<<char(opt)<<"\n";
                 epicsExit(2);
                 return 2;
             case 'a':
-                lazy_dbd(dbd_file);
+                lazy_dbd(dbd_file, prefix);
                 if (!macros.empty()) {
                     if (verbose)
                         std::cout<<"asSetSubstitutions(\""<<macros<<"\")\n";
@@ -183,7 +204,7 @@ int main(int argc, char *argv[])
                 dbd_file = optarg;
                 break;
             case 'd':
-                lazy_dbd(dbd_file);
+                lazy_dbd(dbd_file, prefix);
                 if (verbose) {
                     std::cout<<"dbLoadRecords(\""<<optarg<<"\"";
                     if(!macros.empty())
@@ -206,17 +227,26 @@ int main(int argc, char *argv[])
                 verbose = true;
                 break;
             case 'x':
-                lazy_dbd(dbd_file);
+                lazy_dbd(dbd_file, prefix);
                 xmacro  = "IOC=";
                 xmacro += optarg;
-                errIf(dbLoadRecords(exit_file.c_str(), xmacro.c_str()),
-                      std::string("Failed to load: ")+exit_file);
+                FILE *fp;
+                dbOpenFile(&pdbbase, exit_file.c_str(), &fp);
+                if(!fp){
+                    std::cerr<<"Failed to open exit file "<<exit_file<<"."<<std::endl;
+                    std::cerr<<"Trying to open it relative to EPICS_BASE instead..."<<std::endl;
+                    dbOpenFile(&pdbbase, EXIT_FILE, &fp);
+                    if(fp)
+                        std::cerr<<"Found exit file "<<EXIT_FILE<<"."<<std::endl;
+                }
+                errIf(!fp && dbLoadRecords(exit_file.c_str(), xmacro.c_str()),
+                      std::string("Failed to read: ")+exit_file+"\n");
                 loadedDb = true;
                 break;
             }
         }
 
-        lazy_dbd(dbd_file);
+        lazy_dbd(dbd_file, prefix);
 
         if(optind<argc)  {
             // run script
@@ -256,7 +286,7 @@ int main(int argc, char *argv[])
                 }
 
             } else {
-                usage(argv[0], dbd_file);
+                usage(argv[0], dbd_file, prefix);
                 std::cerr<<"Nothing to do!\n";
                 epicsExit(1);
                 return 1;
Index: epics-base/modules/database/src/ioc/dbStatic/dbLexRoutines.c
===================================================================
--- epics-base.orig/modules/database/src/ioc/dbStatic/dbLexRoutines.c
+++ epics-base/modules/database/src/ioc/dbStatic/dbLexRoutines.c
@@ -159,9 +159,10 @@ static void *getLastTemp(void)
     return(ptempListNode->item);
 }
 
-const char *dbOpenFile(DBBASE *pdbbase,const char *filename,FILE **fp)
+const char *dbOpenFile(DBBASE **ppdbbase,const char *filename,FILE **fp)
 {
-    ELLLIST     *ppathList = (ELLLIST *)pdbbase->pathPvt;
+    if (*ppdbbase == 0) *ppdbbase = dbAllocBase();
+    ELLLIST     *ppathList = (ELLLIST *)(*ppdbbase)->pathPvt;
     dbPathNode  *pdbPathNode;
     char        *fullfilename;
 
@@ -271,7 +272,7 @@ static long dbReadCOM(DBBASE **ppdbbase,
         FILE *fp1 = 0;
 
         if (pinputFile->filename)
-            pinputFile->path = dbOpenFile(pdbbase, pinputFile->filename, &fp1);
+            pinputFile->path = dbOpenFile(&pdbbase, pinputFile->filename, &fp1);
         if (!pinputFile->filename || !fp1) {
             errPrintf(0, __FILE__, __LINE__,
                 "dbRead opening file %s\n",pinputFile->filename);
@@ -431,7 +432,7 @@ static void dbIncludeNew(char *filename)
 
     pinputFile = dbCalloc(1,sizeof(inputFile));
     pinputFile->filename = macEnvExpand(filename);
-    pinputFile->path = dbOpenFile(pdbbase, pinputFile->filename, &fp);
+    pinputFile->path = dbOpenFile(&pdbbase, pinputFile->filename, &fp);
     if (!fp) {
         epicsPrintf("Can't open include file \"%s\"\n", filename);
         yyerror(NULL);
Index: epics-base/modules/database/src/ioc/dbStatic/dbStaticPvt.h
===================================================================
--- epics-base.orig/modules/database/src/ioc/dbStatic/dbStaticPvt.h
+++ epics-base/modules/database/src/ioc/dbStatic/dbStaticPvt.h
@@ -44,7 +44,7 @@ void dbMsgPrint(DBENTRY *pdbentry, const
 void dbPutStringSuggest(DBENTRY *pdbentry, const char *pstring);
 
 DBCORE_API
-const char *dbOpenFile(DBBASE *pdbbase,const char *filename,FILE **fp);
+const char *dbOpenFile(DBBASE **ppdbbase,const char *filename,FILE **fp);
 
 struct jlink;
 
